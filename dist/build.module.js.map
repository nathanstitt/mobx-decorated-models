{"version":3,"file":"build.module.js","sources":["../lib/schema.js","../lib/class-decorator.js","../lib/property-decorators.js"],"sourcesContent":["import { observable } from 'mobx';\n\nexport default function (model) {\n    if (model.$schema) {\n        return model.$schema;\n    }\n    const schema = observable.shallowMap();\n    Object.defineProperty(model, '$schema', {\n        enumerable: false,\n        writable: false,\n        configurable: true,\n        value: schema,\n    });\n    return schema;\n}\n","import {\n    serialize, deserialize, createModelSchema, primitive, list, object,\n    identifier, getDefaultModelSchema, update,\n} from 'serializr';\n\nimport getSchema from './schema';\n\nconst ModelsMap = new Map();\nconst PendingLookups = [];\n\nfunction capitalize(str) {\n    return str.charAt(0).toUpperCase() + str.slice(1);\n}\n\nfunction findModel(name, options) {\n    const modelName = options.className ? options.className : name;\n    return ModelsMap[modelName] || ModelsMap[capitalize(modelName)];\n}\n\nfunction addReference(parentModel, propName, options, cb) {\n    const model = findModel(propName, options);\n    if (model) {\n        getDefaultModelSchema(parentModel).props[propName] = cb(model, options);\n    } else {\n        PendingLookups.push({ parentModel, propName, options, cb });\n    }\n}\n\nfunction readonlyPrimitive(){\n    const defaultSerial = primitive();\n    return {\n        serializer: () => undefined,\n        deserializer: defaultSerial.deserializer,\n    };\n}\n\nconst SimpleHandlers = {\n    identifier: () => identifier(),\n    field: () => primitive(),\n    session: () => readonlyPrimitive(),\n};\n\nconst AsyncHandlers = {\n    hasMany: model => list(object(model)),\n    belongsTo: model => object(model),\n};\n\nconst MixedInInstanceMethods = {\n\n    serialize() {\n        const schema = getDefaultModelSchema(this.constructor);\n        return serialize(schema, this);\n    },\n\n    update(json, callback) {\n        return update(getDefaultModelSchema(this.constructor), this, json, callback);\n    },\n\n};\n\nconst MixedInClassMethods = {\n\n    deserialize(json, callback) {\n        return deserialize(getDefaultModelSchema(this), json, callback);\n    },\n\n};\n\nexport default function (model) {\n\n    Object.assign(model.prototype, MixedInInstanceMethods);\n    Object.assign(model, MixedInClassMethods);\n\n    const schema = getSchema(model);\n\n    ModelsMap[model.name] = model;\n    const serializeSchema = {};\n\n    schema.forEach(({ type, options }, name) => {\n        if (SimpleHandlers[type]) {\n            serializeSchema[name] = SimpleHandlers[type](options, name);\n        }\n    });\n\n    createModelSchema(model, serializeSchema);\n\n    schema.forEach(({ type, options }, name) => {\n        if (AsyncHandlers[type]) {\n            addReference(model, name, options, AsyncHandlers[type]);\n        }\n    });\n\n    for (let i = PendingLookups.length - 1; i >= 0; i -= 1) {\n        const { parentModel, propName, options, cb } = PendingLookups[i];\n        const referencedModel = findModel(propName, options);\n\n        if (referencedModel) {\n            const parentModelSchema = getDefaultModelSchema(parentModel);\n            parentModelSchema.props[propName] = cb(model, options);\n            PendingLookups.splice(i, 1);\n        }\n    }\n}\n","import {\n    observable,\n} from 'mobx';\n\nimport getModelSchema from './schema';\n\nfunction addAttribute(type, target, property, descriptor, options = {}) {\n    getModelSchema(target.constructor).set(property, { name: property, type, options });\n    return observable(target, property, descriptor);\n}\n\nfunction buildAttributeDecorator(type, args, attributeAddFn = addAttribute) {\n    if ((typeof args[0] === 'object') && args.length === 1) {\n        return (target, property, descriptor) =>\n            attributeAddFn(type, target, property, descriptor, args[0]);\n    }\n    return attributeAddFn(type, ...args, {});\n}\n\nconst identifier = (...args) =>  buildAttributeDecorator('identifier', args);\nconst field = (...args) => buildAttributeDecorator('field', args);\nconst session = (...args) => buildAttributeDecorator('session', args);\nconst belongsTo = (...args) => buildAttributeDecorator('belongsTo', args);\n\nconst hasManyBuilder = (type, target, property, descriptor, options = {}) => {\n    descriptor.initializer = () => observable.array([]);\n    return addAttribute(type, target, property, descriptor, options);\n};\nconst hasMany = (...args) => buildAttributeDecorator('hasMany', args, hasManyBuilder);\n\n\nexport { field, session, belongsTo, hasMany, identifier };\n"],"names":["model","$schema","schema","observable","shallowMap","defineProperty","ModelsMap","Map","PendingLookups","capitalize","str","charAt","toUpperCase","slice","findModel","name","options","modelName","className","addReference","parentModel","propName","cb","props","push","readonlyPrimitive","defaultSerial","primitive","undefined","deserializer","SimpleHandlers","identifier","AsyncHandlers","list","object","MixedInInstanceMethods","getDefaultModelSchema","constructor","serialize","json","callback","update","MixedInClassMethods","deserialize","assign","prototype","getSchema","serializeSchema","forEach","type","i","length","referencedModel","parentModelSchema","splice","addAttribute","target","property","descriptor","set","buildAttributeDecorator","args","attributeAddFn","babelHelpers.typeof","field","session","belongsTo","hasManyBuilder","initializer","array","hasMany"],"mappings":"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"}